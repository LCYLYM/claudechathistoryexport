<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Claude对话查看器简单测试</h1>
        <p>测试修复后的查看器功能</p>
        
        <div>
            <button onclick="testLibraries()">测试库加载</button>
            <button onclick="testJSONLoad()">测试JSON加载</button>
            <button onclick="openViewer()">打开查看器</button>
            <button onclick="openViewerWithData()">加载测试数据</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function showResult(message, type = 'result') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function testLibraries() {
            showResult('正在测试库加载状态...', 'result');
            
            let status = '<h3>库加载状态:</h3><ul>';
            
            // 测试marked
            if (typeof marked !== 'undefined') {
                status += '<li>✅ Marked库已加载</li>';
                try {
                    const testMd = marked.parse('# 测试');
                    status += '<li>✅ Marked功能正常</li>';
                } catch (e) {
                    status += '<li>❌ Marked功能异常: ' + e.message + '</li>';
                }
            } else {
                status += '<li>❌ Marked库未加载</li>';
            }
            
            // 测试DOMPurify
            if (typeof DOMPurify !== 'undefined') {
                status += '<li>✅ DOMPurify库已加载</li>';
                try {
                    const testHtml = DOMPurify.sanitize('<p>测试</p>');
                    status += '<li>✅ DOMPurify功能正常</li>';
                } catch (e) {
                    status += '<li>❌ DOMPurify功能异常: ' + e.message + '</li>';
                }
            } else {
                status += '<li>❌ DOMPurify库未加载</li>';
            }
            
            status += '</ul>';
            showResult(status, 'success');
        }

        async function testJSONLoad() {
            showResult('正在测试JSON文件加载...', 'result');
            
            try {
                const response = await fetch('./新json适配/claude_946a2b2a_2025-05-31.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                let info = '<h3>JSON加载成功:</h3>';
                info += `<p><strong>对话名称:</strong> ${data.name}</p>`;
                info += `<p><strong>消息数量:</strong> ${data.chat_messages.length}</p>`;
                info += `<p><strong>UUID:</strong> ${data.uuid}</p>`;
                
                // 检查消息结构
                const firstMessage = data.chat_messages[0];
                info += '<h4>第一条消息:</h4>';
                info += `<p><strong>发送者:</strong> ${firstMessage.sender}</p>`;
                info += `<p><strong>父消息UUID:</strong> ${firstMessage.parent_message_uuid}</p>`;
                info += `<p><strong>内容块数量:</strong> ${firstMessage.content ? firstMessage.content.length : 0}</p>`;
                
                if (firstMessage.content && firstMessage.content.length > 0) {
                    info += `<p><strong>第一个内容块类型:</strong> ${firstMessage.content[0].type}</p>`;
                    info += `<p><strong>第一个内容块文本:</strong> ${firstMessage.content[0].text ? firstMessage.content[0].text.substring(0, 50) + '...' : '无'}</p>`;
                }
                
                showResult(info, 'success');
                
            } catch (error) {
                showResult(`<h3>JSON加载失败:</h3><p>${error.message}</p>`, 'error');
            }
        }

        function openViewer() {
            window.open('./viewer.html', '_blank');
            showResult('已在新窗口打开查看器', 'success');
        }

        async function openViewerWithData() {
            showResult('正在加载测试数据到查看器...', 'result');
            
            try {
                const response = await fetch('./新json适配/claude_946a2b2a_2025-05-31.json');
                const data = await response.json();
                
                // 将数据编码到URL中
                const encodedData = encodeURIComponent(JSON.stringify(data));
                const viewerUrl = `./viewer.html?data=${encodedData}`;
                
                window.open(viewerUrl, '_blank');
                showResult('已在新窗口打开查看器并加载测试数据', 'success');
                
            } catch (error) {
                showResult(`<h3>加载失败:</h3><p>${error.message}</p>`, 'error');
            }
        }

        // 页面加载时显示说明
        window.addEventListener('load', () => {
            showResult('页面加载完成，可以开始测试', 'result');
        });
    </script>
</body>
</html>

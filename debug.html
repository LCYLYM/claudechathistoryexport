<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试JSON解析</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background: #f5f5f5;
        }
        .debug-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .message-item {
            border: 1px solid #eee;
            margin: 5px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .human { background: #e3f2fd; }
        .assistant { background: #f3e5f5; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>Claude对话JSON解析调试</h1>
        
        <button onclick="debugJSON()">调试JSON解析</button>
        <button onclick="testViewer()">测试查看器</button>
        
        <div id="debug-output"></div>
    </div>

    <script>
        async function debugJSON() {
            const output = document.getElementById('debug-output');
            output.innerHTML = '<p>正在加载JSON...</p>';
            
            try {
                const response = await fetch('./新json适配/claude_946a2b2a_2025-05-31.json');
                const data = await response.json();
                
                let html = '<div class="debug-section">';
                html += '<h3>基本信息</h3>';
                html += `<p><strong>UUID:</strong> ${data.uuid}</p>`;
                html += `<p><strong>名称:</strong> ${data.name}</p>`;
                html += `<p><strong>消息数量:</strong> ${data.chat_messages.length}</p>`;
                html += `<p><strong>当前叶子消息:</strong> ${data.current_leaf_message_uuid}</p>`;
                html += '</div>';
                
                html += '<div class="debug-section">';
                html += '<h3>消息列表</h3>';
                
                data.chat_messages.forEach((message, index) => {
                    const senderClass = message.sender === 'human' ? 'human' : 'assistant';
                    html += `<div class="message-item ${senderClass}">`;
                    html += `<strong>消息 ${index + 1}</strong> (${message.sender})<br>`;
                    html += `UUID: ${message.uuid}<br>`;
                    html += `父消息: ${message.parent_message_uuid}<br>`;
                    html += `创建时间: ${message.created_at}<br>`;
                    
                    // 显示内容
                    if (message.content && message.content.length > 0) {
                        html += `内容块数量: ${message.content.length}<br>`;
                        message.content.forEach((content, i) => {
                            html += `&nbsp;&nbsp;块${i+1}: ${content.type} - "${content.text ? content.text.substring(0, 50) + '...' : '无文本'}"<br>`;
                        });
                    } else if (message.text) {
                        html += `文本: ${message.text.substring(0, 100)}...<br>`;
                    } else {
                        html += `<span class="error">无内容</span><br>`;
                    }
                    
                    // 显示附件和文件
                    if (message.attachments && message.attachments.length > 0) {
                        html += `附件: ${message.attachments.length}个<br>`;
                    }
                    if (message.files && message.files.length > 0) {
                        html += `文件: ${message.files.length}个<br>`;
                    }
                    
                    html += '</div>';
                });
                
                html += '</div>';
                
                // 分析消息树结构
                html += '<div class="debug-section">';
                html += '<h3>消息树分析</h3>';
                
                const messageMap = new Map();
                const rootMessages = [];
                
                // 构建消息映射
                data.chat_messages.forEach(message => {
                    messageMap.set(message.uuid, {
                        ...message,
                        children: []
                    });
                });
                
                // 建立父子关系
                data.chat_messages.forEach(message => {
                    const hasValidParent = message.parent_message_uuid && 
                                         message.parent_message_uuid !== "00000000-0000-4000-8000-000000000000";
                    
                    if (hasValidParent) {
                        const parent = messageMap.get(message.parent_message_uuid);
                        if (parent) {
                            parent.children.push(message.uuid);
                        } else {
                            rootMessages.push(message.uuid);
                            html += `<p class="error">警告: 消息 ${message.uuid} 的父消息 ${message.parent_message_uuid} 不存在</p>`;
                        }
                    } else {
                        rootMessages.push(message.uuid);
                    }
                });
                
                html += `<p><strong>根消息数量:</strong> ${rootMessages.length}</p>`;
                html += '<p><strong>消息树结构:</strong></p>';
                html += '<pre>';
                
                function printTree(messageId, depth = 0) {
                    const message = messageMap.get(messageId);
                    if (!message) return '';
                    
                    const indent = '  '.repeat(depth);
                    let result = `${indent}├─ ${message.sender}: ${message.uuid.substring(0, 8)}\n`;
                    
                    if (message.content && message.content.length > 0) {
                        const textContent = message.content.find(c => c.type === 'text');
                        if (textContent) {
                            result += `${indent}   "${textContent.text.substring(0, 30)}..."\n`;
                        }
                    }
                    
                    message.children.forEach(childId => {
                        result += printTree(childId, depth + 1);
                    });
                    
                    return result;
                }
                
                rootMessages.forEach(rootId => {
                    html += printTree(rootId);
                });
                
                html += '</pre>';
                html += '</div>';
                
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = `<p class="error">错误: ${error.message}</p>`;
                console.error('调试错误:', error);
            }
        }
        
        async function testViewer() {
            try {
                const response = await fetch('./新json适配/claude_946a2b2a_2025-05-31.json');
                const data = await response.json();
                
                const encodedData = encodeURIComponent(JSON.stringify(data));
                const viewerUrl = `./viewer.html?data=${encodedData}`;
                
                window.open(viewerUrl, '_blank');
                
            } catch (error) {
                alert('测试失败: ' + error.message);
            }
        }
    </script>
</body>
</html>

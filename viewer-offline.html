<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claudeå¯¹è¯æŸ¥çœ‹å™¨ (ç¦»çº¿ç‰ˆ)</title>
    <link rel="stylesheet" href="viewer.css">
    <style>
        /* ç®€å•çš„Markdownæ ·å¼ */
        .content-text h1, .content-text h2, .content-text h3 {
            margin: 16px 0 8px 0;
            font-weight: bold;
        }
        .content-text h1 { font-size: 1.5em; }
        .content-text h2 { font-size: 1.3em; }
        .content-text h3 { font-size: 1.1em; }
        .content-text p { margin: 8px 0; }
        .content-text ul, .content-text ol { margin: 8px 0; padding-left: 20px; }
        .content-text li { margin: 4px 0; }
        .content-text code {
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .content-text pre {
            background: #1e293b;
            color: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: monospace;
        }
        .content-text blockquote {
            border-left: 4px solid #667eea;
            padding-left: 12px;
            margin: 8px 0;
            color: #64748b;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="viewer-container">
        <!-- å¤´éƒ¨å·¥å…·æ  -->
        <header class="viewer-header">
            <div class="header-left">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <div class="header-info">
                    <h1>Claudeå¯¹è¯æŸ¥çœ‹å™¨ (ç¦»çº¿ç‰ˆ)</h1>
                    <p id="conversation-title">è¯·ä¸Šä¼ JSONæ–‡ä»¶</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="upload-json">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    ä¸Šä¼ JSON
                </button>
                <button class="btn btn-secondary" id="export-html" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    å¯¼å‡ºHTML
                </button>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="viewer-main">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-area" id="upload-area">
                <div class="upload-content">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor" class="upload-icon">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    <h3>æ‹–æ‹½JSONæ–‡ä»¶åˆ°æ­¤å¤„</h3>
                    <p>æˆ–ç‚¹å‡»ä¸Šæ–¹"ä¸Šä¼ JSON"æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                    <p class="upload-hint">æ”¯æŒClaudeå¯¼å‡ºçš„å¤šåˆ†æ”¯å¯¹è¯JSONæ–‡ä»¶ (ç¦»çº¿ç‰ˆæœ¬)</p>
                </div>
            </div>

            <!-- å¯¹è¯å†…å®¹åŒºåŸŸ -->
            <div class="conversation-content" id="conversation-content" style="display: none;">
                <!-- å¯¹è¯ä¿¡æ¯é¢æ¿ -->
                <div class="conversation-info" id="conversation-info">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="conversation-controls">
                    <div class="view-options">
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-tree-view" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">æ ‘å½¢è§†å›¾</span>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-timestamps" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">æ˜¾ç¤ºæ—¶é—´æˆ³</span>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-tools" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">æ˜¾ç¤ºå·¥å…·è°ƒç”¨</span>
                        </label>
                    </div>
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="æœç´¢å¯¹è¯å†…å®¹...">
                        <button id="search-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- å¯¹è¯æ ‘å½¢ç»“æ„ -->
                <div class="conversation-tree" id="conversation-tree">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </main>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="file-input" accept=".json" style="display: none;">

    <script>
        // ç®€åŒ–ç‰ˆçš„ConversationViewerï¼Œä¸ä¾èµ–å¤–éƒ¨åº“
        class OfflineConversationViewer {
            constructor() {
                this.currentData = null;
                this.messageTree = new Map();
                this.rootMessages = [];
                this.searchTerm = '';
                this.viewOptions = {
                    showTreeView: true,
                    showTimestamps: true,
                    showTools: true
                };
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadFromUrl();
            }

            bindEvents() {
                // æ–‡ä»¶ä¸Šä¼ 
                const fileInput = document.getElementById('file-input');
                const uploadBtn = document.getElementById('upload-json');
                const uploadArea = document.getElementById('upload-area');

                uploadBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));

                // æ‹–æ‹½ä¸Šä¼ 
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFiles(e.dataTransfer.files);
                });

                // è§†å›¾é€‰é¡¹
                document.getElementById('show-tree-view').addEventListener('change', (e) => {
                    this.viewOptions.showTreeView = e.target.checked;
                    this.renderConversation();
                });

                document.getElementById('show-timestamps').addEventListener('change', (e) => {
                    this.viewOptions.showTimestamps = e.target.checked;
                    this.renderConversation();
                });

                document.getElementById('show-tools').addEventListener('change', (e) => {
                    this.viewOptions.showTools = e.target.checked;
                    this.renderConversation();
                });

                // æœç´¢
                document.getElementById('search-btn').addEventListener('click', () => this.performSearch());
                document.getElementById('search-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.performSearch();
                });

                // å¯¼å‡º
                document.getElementById('export-html').addEventListener('click', () => this.exportToHtml());
            }

            async handleFiles(files) {
                if (files.length === 0) return;
                
                const file = files[0];
                if (!file.name.endsWith('.json')) {
                    alert('è¯·é€‰æ‹©JSONæ–‡ä»¶');
                    return;
                }

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    this.loadConversationData(data);
                } catch (error) {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯: ' + error.message);
                }
            }

            loadFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                if (dataParam) {
                    try {
                        const data = JSON.parse(decodeURIComponent(dataParam));
                        this.loadConversationData(data);
                    } catch (error) {
                        console.error('URLæ•°æ®è§£æå¤±è´¥:', error);
                    }
                }
            }

            loadConversationData(data) {
                console.log('ğŸ”„ åŠ è½½å¯¹è¯æ•°æ®:', data.name);
                this.currentData = data;
                this.buildMessageTree();
                this.renderConversationInfo();
                this.renderConversation();
                this.showConversationContent();
                
                document.getElementById('export-html').style.display = 'inline-flex';
            }

            buildMessageTree() {
                this.messageTree.clear();
                this.rootMessages = [];

                if (!this.currentData.chat_messages) {
                    console.log('âŒ æ²¡æœ‰æ‰¾åˆ°chat_messages');
                    return;
                }

                console.log(`ğŸ“Š å¼€å§‹æ„å»ºæ¶ˆæ¯æ ‘ï¼Œå…± ${this.currentData.chat_messages.length} æ¡æ¶ˆæ¯`);

                // é¦–å…ˆå°†æ‰€æœ‰æ¶ˆæ¯æ·»åŠ åˆ°mapä¸­
                this.currentData.chat_messages.forEach(message => {
                    this.messageTree.set(message.uuid, {
                        ...message,
                        children: []
                    });
                });

                // ç„¶åå»ºç«‹çˆ¶å­å…³ç³»
                this.currentData.chat_messages.forEach(message => {
                    const hasValidParent = message.parent_message_uuid && 
                                         message.parent_message_uuid !== "00000000-0000-4000-8000-000000000000";

                    if (hasValidParent) {
                        const parent = this.messageTree.get(message.parent_message_uuid);
                        if (parent) {
                            parent.children.push(message.uuid);
                        } else {
                            this.rootMessages.push(message.uuid);
                        }
                    } else {
                        this.rootMessages.push(message.uuid);
                    }
                });

                // æŒ‰æ—¶é—´æ’åº
                this.rootMessages.sort((a, b) => {
                    const messageA = this.messageTree.get(a);
                    const messageB = this.messageTree.get(b);
                    return new Date(messageA.created_at) - new Date(messageB.created_at);
                });

                console.log(`ğŸŒ³ æ¶ˆæ¯æ ‘æ„å»ºå®Œæˆ: ${this.rootMessages.length} ä¸ªæ ¹æ¶ˆæ¯`);
            }

            renderConversationInfo() {
                const info = document.getElementById('conversation-info');
                const data = this.currentData;
                
                const createdAt = new Date(data.created_at).toLocaleString('zh-CN');
                const updatedAt = new Date(data.updated_at).toLocaleString('zh-CN');
                const messageCount = data.chat_messages ? data.chat_messages.length : 0;
                
                info.innerHTML = `
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">å¯¹è¯æ ‡é¢˜</div>
                            <div class="info-value">${data.name || 'æœªå‘½åå¯¹è¯'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">æ¶ˆæ¯æ•°é‡</div>
                            <div class="info-value">${messageCount}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">åˆ›å»ºæ—¶é—´</div>
                            <div class="info-value">${createdAt}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">æ›´æ–°æ—¶é—´</div>
                            <div class="info-value">${updatedAt}</div>
                        </div>
                    </div>
                `;

                document.getElementById('conversation-title').textContent = data.name || 'æœªå‘½åå¯¹è¯';
            }

            renderConversation() {
                console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“å¯¹è¯');
                const container = document.getElementById('conversation-tree');
                
                if (!container) {
                    console.error('âŒ æ‰¾ä¸åˆ°conversation-treeå®¹å™¨');
                    return;
                }
                
                container.innerHTML = '';

                if (this.rootMessages.length === 0) {
                    container.innerHTML = '<div class="no-messages">æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯</div>';
                    return;
                }

                console.log(`âœ… å¼€å§‹æ¸²æŸ“ ${this.rootMessages.length} æ¡æ¶ˆæ¯`);
                this.rootMessages.forEach((messageId, index) => {
                    this.renderMessageNode(container, messageId, 0);
                });
                console.log('ğŸ¨ å¯¹è¯æ¸²æŸ“å®Œæˆ');
            }

            renderMessageNode(container, messageId, depth) {
                const message = this.messageTree.get(messageId);
                if (!message) return;

                const messageElement = this.createMessageElement(message, depth);
                container.appendChild(messageElement);

                if (this.viewOptions.showTreeView && message.children.length > 0) {
                    message.children.forEach(childId => {
                        this.renderMessageNode(container, childId, depth + 1);
                    });
                }
            }

            createMessageElement(message, depth) {
                const div = document.createElement('div');
                div.className = `message-node ${depth > 0 ? 'branch-indicator' : ''}`;
                div.style.marginLeft = `${depth * 20}px`;

                const senderClass = message.sender === 'human' ? 'sender-human' : 'sender-assistant';
                const senderName = message.sender === 'human' ? 'ç”¨æˆ·' : 'Claude';
                const senderInitial = message.sender === 'human' ? 'U' : 'C';

                const timestamp = this.viewOptions.showTimestamps ? 
                    `<div class="message-timestamp">${new Date(message.created_at).toLocaleString('zh-CN')}</div>` : '';

                div.innerHTML = `
                    <div class="message-header">
                        <div class="message-sender ${senderClass}">
                            <div class="sender-avatar">${senderInitial}</div>
                            <span>${senderName}</span>
                        </div>
                        ${timestamp}
                    </div>
                    <div class="message-content">
                        ${this.renderMessageContent(message)}
                    </div>
                `;

                return div;
            }

            renderMessageContent(message) {
                let contentHtml = '';

                // å¤„ç†æ–°æ ¼å¼çš„contentæ•°ç»„
                if (message.content && Array.isArray(message.content) && message.content.length > 0) {
                    contentHtml = message.content.map(content => {
                        return this.renderContentBlock(content);
                    }).join('');
                }
                // å¤„ç†æ—§æ ¼å¼çš„textå­—æ®µ
                else if (message.text) {
                    contentHtml = this.renderTextContent(message.text);
                }
                else {
                    contentHtml = '<div class="content-text">æ— å†…å®¹</div>';
                }

                return contentHtml;
            }

            renderContentBlock(content) {
                let contentHtml = '';

                switch (content.type) {
                    case 'text':
                        contentHtml = this.renderTextContent(content.text);
                        break;
                    case 'tool_use':
                        contentHtml = this.viewOptions.showTools ? this.renderToolUse(content) : '';
                        break;
                    case 'tool_result':
                        contentHtml = this.viewOptions.showTools ? this.renderToolResult(content) : '';
                        break;
                    default:
                        contentHtml = `<div class="content-unknown">
                            <strong>æœªçŸ¥å†…å®¹ç±»å‹:</strong> ${content.type}
                        </div>`;
                }

                return contentHtml;
            }

            renderTextContent(text) {
                if (!text) return '';
                
                // ç®€å•çš„æ–‡æœ¬å¤„ç†ï¼Œä¸ä¾èµ–marked
                const escaped = this.escapeHtml(text);
                const withBreaks = escaped.replace(/\n/g, '<br>');
                
                return `<div class="content-block"><div class="content-text">${withBreaks}</div></div>`;
            }

            renderToolUse(toolUse) {
                const toolName = toolUse.name || 'æœªçŸ¥å·¥å…·';
                const inputJson = JSON.stringify(toolUse.input || {}, null, 2);

                return `
                    <div class="content-block">
                        <div class="tool-use">
                            <div class="tool-header">
                                ğŸ”§ å·¥å…·è°ƒç”¨: <strong>${toolName}</strong>
                            </div>
                            <div class="tool-input"><pre>${inputJson}</pre></div>
                        </div>
                    </div>
                `;
            }

            renderToolResult(toolResult) {
                let resultContent = '';
                if (toolResult.content) {
                    if (typeof toolResult.content === 'string') {
                        resultContent = this.escapeHtml(toolResult.content);
                    } else {
                        resultContent = JSON.stringify(toolResult.content, null, 2);
                    }
                }

                return `
                    <div class="content-block">
                        <div class="tool-result">
                            <div class="tool-result-header">
                                âœ… å·¥å…·ç»“æœ
                            </div>
                            <div class="tool-result-content"><pre>${resultContent}</pre></div>
                        </div>
                    </div>
                `;
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showConversationContent() {
                document.getElementById('upload-area').style.display = 'none';
                document.getElementById('conversation-content').style.display = 'flex';
            }

            performSearch() {
                this.searchTerm = document.getElementById('search-input').value.toLowerCase();
                this.renderConversation();
            }

            exportToHtml() {
                if (!this.currentData) return;
                
                const conversationHtml = document.getElementById('conversation-tree').innerHTML;
                const infoHtml = document.getElementById('conversation-info').innerHTML;
                
                const html = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${this.currentData.name || 'æœªå‘½åå¯¹è¯'} - Claudeå¯¹è¯å¯¼å‡º</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; }
        .conversation-info { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .message-node { background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 16px; padding: 16px; }
        .message-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-weight: bold; }
        .sender-human { color: #667eea; }
        .sender-assistant { color: #f093fb; }
        .content-text { line-height: 1.6; }
        .tool-use, .tool-result { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; padding: 12px; margin: 8px 0; }
        pre { background: #f8f9fa; padding: 8px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Claudeå¯¹è¯å¯¼å‡º</h1>
    <p>å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}</p>
    <div class="conversation-info">${infoHtml}</div>
    <div class="conversation-tree">${conversationHtml}</div>
</body>
</html>
                `;
                
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `claude_conversation_${this.currentData.uuid.substring(0, 8)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // åˆå§‹åŒ–æŸ¥çœ‹å™¨
        const viewer = new OfflineConversationViewer();
        window.viewer = viewer;
    </script>
</body>
</html>
